<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta charset="utf-8" />
        <title>JSON browser</title>
    </head>
      <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
  <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
  <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
    <script>
        if (typeof String.prototype.startsWith != 'function') {
            // see below for better implementation!
            String.prototype.startsWith = function (str){
                return this.indexOf(str) == 0;
            };
        }

        var currentTags = null;

        function createAnchor(uri) {
            var currentUrl = document.URL;
            if (uri.startsWith(currentUrl))
                uri = uri.substring(currentUrl.length);
            
            return $('<a href="' + uri + '" />').text('"' + uri + '"').click(function() {
                fetchUri(uri, $("article"), false, true);
                return false;
            });
        }

        function jsToHtml(el, o) {
            if (o === null) {
                el.append($('<span class="js_null">null</span>'));
                return;
            }

            if ($.isArray(o)) {
                if (o.length == 0) {
                    el.append($('<span class="js_empty_array_info">(empty array)</span>'));
                }

                var arrList = $('<ul class="js_array"></ul>');
                for (var i = 0; i < o.length; i++) {
                    var item = o[i];
                    var itemLi = $('<li />');
                    jsToHtml(itemLi, item);
                    arrList.append(itemLi);
                }
                el.append(arrList);
                return;
            }

            switch (typeof o) {
            case "object":
                if (o._ref) {
                    var refUri = o._ref;
                    var expandButton = $('<span class="fetch_ref_obj">(get)</span>');
                    expandButton.click(function() {
                        fetchUri(refUri, el, true);
                    });
                    el.append(expandButton);
                    el.append($('<span class="js_obj_ref" />').append(createAnchor(refUri)));
                    return;
                }
                    
                if (o._uri) {
                    el.append($('<span class="js_obj_uri" />').append(createAnchor(o._uri)));
                }

                var propList = $('<ul class="js_obj"></ul>');
                for (var propName in o) {
                    if (propName === '_uri' || propName === '_type')
                        continue;

                    var propValue = o[propName];
                    var propLi = $('<li />');
                    propLi.append($('<label js_prop_name />').text(propName));
                    var propValueSpan = $('<span class="js_prop_value" />');
                    jsToHtml(propValueSpan, propValue);
                    propLi.append(propValueSpan);
                    propList.append(propLi);
                }
                el.append(propList);
                break;
            case "string":
                if (o.indexOf("\n") !== -1) {
                    el.append($("<pre class='js_multiline_string' />").text(o));
                } else {
                    el.append($('<span />').text('"' + o + '"'));
                }
                break;
            default:
                el.append($('<span />').text(o));
                break;
            }
        }

        function fetchUri(uri, element, unwrapItems, setUriInputElement, keepFuture) {
            if (element === undefined)
                element = $("article");

            element.empty();
            element.append($('<div class="resource_loading">Loading..</div>'));

            if (setUriInputElement) {
                $("#fetch_uri").val(uri);
            }

            $.getJSON(uri, function (data) {
                if (unwrapItems) {
                    if (data._type === '__result__') {
                        data = data.items;
                    }
                }
                element.empty();
                jsToHtml(element, data);
                //$("pre").text(JSON.stringify(data, null, 4));
            });
        }
        $(function () {
            $.getJSON("schemas", function (schemas) {

                $.each(schemas.types, function (i, v) {
                    if (v.extends)
                        return;

                    var li = $("<li />");
                    var anchor = $("<a />");

                    anchor.click(function () {
                        fetchUri(v.uri, $("article"), false, true);
                        currentTags = Object.keys(v.properties);
                    });
                    //anchor.attr("href", v.uri);
                    anchor.text(v.name);
                    li.append(anchor);
                    $("ul").append(li);
                });
            });

            $('#fetch_uri').keypress(function (e) {
                if (e.which == 13) {
                    fetchUri($("#fetch_uri").val(), $("article"), false, true);
                    return false;    //<---- Add this line
                }
            });

            function split(val) {
                return val.split(/[\. ]\s*/);
            }
            function extractLast(term) {
                return split(term).pop();
            }

            $("#tags")
                // don't navigate away from the field on tab when selecting an item
                .bind("keydown", function (event) {
                    if (event.keyCode === $.ui.keyCode.TAB &&
                        $(this).data("ui-autocomplete").menu.active) {
                        event.preventDefault();
                    }
                })
                .autocomplete({
                    minLength: 0,
                    source: function (request, response) {
                        // delegate back to autocomplete, but extract the last term
                        response($.ui.autocomplete.filter(
                            currentTags, extractLast(request.term)));
                    },
                    focus: function () {
                        // prevent value inserted on focus
                        return false;
                    },
                    select: function (event, ui) {
                        var terms = split(this.value);
                        // remove the current input
                        terms.pop();
                        // add the selected item
                        terms.push(ui.item.value);
                        // add placeholder to get the comma-and-space at the end
                        terms.push("");
                        this.value = terms.join(" ");
                        return false;
                    }
                });
        });
    </script>
    <body>
<div class="ui-widget">
    <span>Path:</span><input id="fetch_uri" size="100" />
</div>
        <article></article>
        <nav>
            <ul></ul>
        </nav>
        <pre></pre>
    </body>
</html>